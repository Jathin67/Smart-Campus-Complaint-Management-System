<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Campus Complaint System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dashboard">
    <div class="dashboard-header">
        <h1>Admin Dashboard</h1>
        <div class="user-info">
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="dashboard-shell">
        <aside class="sidebar">
            <div class="brand">
                <img src="/College-Logo.jpg" alt="Logo">
                <div>
                    <div>Complaint System</div>
                    <div class="role">Admin</div>
                </div>
            </div>
            <div class="nav-section">
                <a class="nav-item" href="#analytics">Analytics & Statistics</a>
                <a class="nav-item" href="#complaints">All Complaints</a>
                <a class="nav-item" href="#users">User Management</a>
                <a class="nav-item" href="/index.html">Home</a>
            </div>
        </aside>
        <main class="main">
    <div class="dashboard-content">
        <!-- Welcome Message -->
        <div class="welcome-card" style="margin-bottom: 24px; background: #ffffff !important; padding: 24px 28px; border-radius: 20px; border: 2px solid rgba(255, 200, 210, 0.4); box-shadow: 0 8px 24px rgba(255, 107, 107, 0.12), 0 2px 8px rgba(255, 182, 193, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.9);">
                <h2 style="margin: 0; color: #3B82F6 !important; font-size: 32px; font-weight: 700; letter-spacing: -0.5px;">Hello, <span id="welcomeName" style="color: #3B82F6 !important; font-weight: 800; text-shadow: none;">Admin</span>!</h2>
        </div>

        <!-- Horizontal Dashboard Sections -->
        <div class="dashboard-sections-grid admin-dashboard-grid">
        <!-- Analytics Dashboard -->
        <div class="card dashboard-section-card" id="analytics">
            <h2>Analytics & Statistics</h2>
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <select id="timeFilter" onchange="loadAnalytics()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="all">All Time</option>
                    <option value="yearly">Yearly</option>
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="daily">Daily</option>
                </select>
                <select id="analyticsSchoolFilter" onchange="loadAnalytics()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="">All Schools</option>
                </select>
                <select id="analyticsDeptFilter" onchange="loadAnalytics()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="">All Departments</option>
                </select>
            </div>
            
            <!-- Priority Filter Cards -->
            <div class="priority-filter-grid" style="margin-bottom: 32px; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                <div class="priority-filter-card" data-priority="urgent" onclick="filterByPriority('urgent')" style="cursor: pointer; padding: 28px 24px; background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%); border-radius: 16px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(21, 101, 192, 0.25); position: relative; overflow: hidden;">
                    <div style="font-size: 40px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 2px 8px rgba(0,0,0,0.2);" id="urgentCount">0</div>
                    <div style="font-weight: 600; font-size: 15px; letter-spacing: 0.5px; opacity: 0.95;">Urgent Priority</div>
                </div>
                <div class="priority-filter-card" data-priority="high" onclick="filterByPriority('high')" style="cursor: pointer; padding: 28px 24px; background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%); border-radius: 16px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(30, 136, 229, 0.25); position: relative; overflow: hidden;">
                    <div style="font-size: 40px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 2px 8px rgba(0,0,0,0.2);" id="highCount">0</div>
                    <div style="font-weight: 600; font-size: 15px; letter-spacing: 0.5px; opacity: 0.95;">High Priority</div>
                </div>
                <div class="priority-filter-card" data-priority="medium" onclick="filterByPriority('medium')" style="cursor: pointer; padding: 28px 24px; background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%); border-radius: 16px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(66, 165, 245, 0.25); position: relative; overflow: hidden;">
                    <div style="font-size: 40px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 2px 8px rgba(0,0,0,0.2);" id="mediumCount">0</div>
                    <div style="font-weight: 600; font-size: 15px; letter-spacing: 0.5px; opacity: 0.95;">Medium Priority</div>
                </div>
                <div class="priority-filter-card" data-priority="low" onclick="filterByPriority('low')" style="cursor: pointer; padding: 28px 24px; background: linear-gradient(135deg, #64B5F6 0%, #42A5F5 100%); border-radius: 16px; color: white; text-align: center; box-shadow: 0 4px 20px rgba(100, 181, 246, 0.25); position: relative; overflow: hidden;">
                    <div style="font-size: 40px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 2px 8px rgba(0,0,0,0.2);" id="lowCount">0</div>
                    <div style="font-weight: 600; font-size: 15px; letter-spacing: 0.5px; opacity: 0.95;">Low Priority</div>
                </div>
            </div>
            
            <!-- Statistics Cards -->
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card" style="border-top: 4px solid #EF4444;">
                    <div style="font-size: 42px; font-weight: bold; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px;" id="rejectedComplaints">0</div>
                    <div class="stat-label" style="color: #666; font-weight: 600;">Rejected</div>
                </div>
                <div class="stat-card" style="border-top: 4px solid #3B82F6;">
                    <div style="font-size: 42px; font-weight: bold; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px;" id="inProgressComplaints">0</div>
                    <div class="stat-label" style="color: #666; font-weight: 600;">In Progress</div>
                </div>
                <div class="stat-card" style="border-top: 4px solid #3B82F6;">
                    <div style="font-size: 42px; font-weight: bold; background: linear-gradient(135deg, #10B981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px;" id="completedComplaints">0</div>
                    <div class="stat-label" style="color: #666; font-weight: 600;">Completed</div>
                </div>
                <div class="stat-card" style="border-top: 4px solid #FBC02D;">
                    <div style="font-size: 42px; font-weight: bold; background: linear-gradient(135deg, #FBC02D 0%, #F9A825 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px;" id="pendingComplaints">0</div>
                    <div class="stat-label" style="color: #666; font-weight: 600;">Pending</div>
                </div>
            </div>

            <!-- Charts -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <h3 style="margin-top: 0;">Complaints by School</h3>
                    <canvas id="schoolChart" style="max-height: 300px;"></canvas>
                </div>
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <h3 style="margin-top: 0;">Complaints by Department</h3>
                    <canvas id="departmentChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0;">
                <h3 style="margin-top: 0;">Complaints Status Over Time</h3>
                <canvas id="statusChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Complaints View with Filters -->
        <div class="card dashboard-section-card" id="complaints">
            <h2>All Complaints</h2>
            <div class="filter-bar" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <select id="schoolFilter" onchange="loadComplaints()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="">All Schools</option>
                </select>
                <select id="deptFilter" onchange="loadComplaints()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="">All Departments</option>
                </select>
                <select id="statusFilter" onchange="loadComplaints()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="rejected">Rejected</option>
                </select>
                <select id="priorityFilter" onchange="loadComplaints()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="">All Priorities</option>
                    <option value="urgent">Urgent</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                <select id="categoryFilter" onchange="loadComplaints()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <option value="">All Categories</option>
                    <option value="hostel">Hostel</option>
                    <option value="classroom">Classroom</option>
                    <option value="washrooms">Washrooms</option>
                    <option value="security">Security</option>
                    <option value="parking">Parking</option>
                    <option value="campus">Campus</option>
                    <option value="academics">Academics</option>
                    <option value="canteen">Canteen/Cafeteria</option>
                    <option value="food-court">Food Court</option>
                    <option value="transportation">Transportation</option>
                    <option value="library">Library</option>
                    <option value="others">Others</option>
                </select>
            </div>
            <div class="complaint-list" id="complaintList">
                <p>Loading complaints...</p>
            </div>
        </div>

        <!-- User Management -->
        <div class="card dashboard-section-card" id="users">
            <h2>User Management</h2>
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group" style="flex:1; margin-right: 10px;">
                    <label>First Name</label>
                    <input type="text" id="umFirstName" data-nav="user-form">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>Last Name</label>
                    <input type="text" id="umLastName" data-nav="user-form">
                </div>
            </div>
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group" style="flex:1; margin-right: 10px;" id="umEmailGroup">
                    <label>Email <span id="umEmailLabel" style="font-weight:normal; color:#6b7280;"></span></label>
                    <input type="email" id="umEmail" data-nav="user-form" placeholder="yourname@gmail.com">
                    <small id="umEmailHint" style="display:none; color:#6b7280;"></small>
                </div>
                <div class="form-group" style="flex:1;">
                    <label>Phone (10-digit)</label>
                    <input type="tel" id="umPhone" placeholder="e.g. 9876543210" pattern="^[6-9][0-9]{9}$" data-nav="user-form">
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
                <label>Password</label>
                <div class="input-group">
                    <input type="password" id="umPassword" placeholder="Set only when creating user" data-nav="user-form">
                    <button type="button" id="umPasswordToggle" class="password-toggle" aria-label="Show password">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M12 5c-5.05 0-9.27 3.17-11 7 1.73 3.83 5.95 7 11 7s9.27-3.17 11-7c-1.73-3.83-5.95-7-11-7zm0 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" fill="currentColor"></path>
                            <path class="slash" d="M4 4l16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                        </svg>
                    </button>
                </div>
                <small style="display:block; margin-top:4px; color:#6b7280;">Password is required only when creating a new user.</small>
            </div>
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group" style="flex:1; margin-right: 10px;">
                    <label>School</label>
                    <select id="umSchool" data-empty-text="Select School" data-nav="user-form">
                        <option value="">Select School</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1;">
                    <label>Department</label>
                    <select id="umDepartment" data-empty-text="Select Department" data-nav="user-form">
                        <option value="">Select Department</option>
                    </select>
                </div>
            </div>
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group" style="flex:1; margin-right: 10px;">
                    <label>Role</label>
                    <select id="umRole" data-nav="user-form">
                        <option value="student">Student</option>
                        <option value="staff">Faculty</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1;">
                    <label>Student ID (optional)</label>
                    <input type="text" id="umStudentId" data-nav="user-form">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="createUser()">Create User</button>
                <button class="btn" style="background:#95a5a6;" onclick="clearUserForm()">Clear</button>
            </div>
            <div style="margin-top:20px; overflow-x:auto;">
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding: 8px; border-bottom:1px solid #eee;">Name</th>
                            <th style="text-align:left; padding: 8px; border-bottom:1px solid #eee;">Email</th>
                            <th style="text-align:left; padding: 8px; border-bottom:1px solid #eee;">Phone</th>
                            <th style="text-align:left; padding: 8px; border-bottom:1px solid #eee;">Role</th>
                            <th style="text-align:left; padding: 8px; border-bottom:1px solid #eee;">Department</th>
                            <th style="text-align:left; padding: 8px; border-bottom:1px solid #eee;">School</th>
                            <th style="text-align:left; padding: 8px; border-bottom:1px solid #eee;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>
        </div>
    </div>
        </main>
    </div>

    <!-- Modal for updating complaint -->
    <div id="updateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">Update Complaint</h2>
            <div class="form-group">
                <label>Status</label>
                <select id="modalStatus">
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            <div class="form-group">
                <label>Admin Notes</label>
                <textarea id="modalNotes" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>Assign To (Staff)</label>
                <select id="modalAssignTo">
                    <option value="">Unassigned</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveComplaintUpdate()">Save</button>
                <button class="btn" style="background: #95a5a6;" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="js/schools-data.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentComplaintId = null;
        let allUsers = [];
        const assetBase = (window.location.origin && window.location.origin !== 'null') ? window.location.origin : '';
        const normalizeValue = (value) => (value || '').toString().trim().toLowerCase();
        const CACHE_TTL = 60000; // 60 seconds
        const dataCache = {
            complaints: null,
            complaintsTimestamp: 0,
            users: null,
            usersTimestamp: 0
        };
        const userSchoolSelect = document.getElementById('umSchool');
        const userDepartmentSelect = document.getElementById('umDepartment');
        let userFormNavElements = [];

        const displayValue = (value) => {
            if (value === null || value === undefined) return '—';
            const normalized = value.toString().trim();
            return normalized.length ? normalized : '—';
        };

        function ensureSelectOption(select, value) {
            if (!select || !value) return;
            const exists = Array.from(select.options || []).some(opt => opt.value === value);
            if (!exists) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            }
        }

        function setAdminFormSchoolAndDepartment(schoolValue, departmentValue) {
            if (userSchoolSelect) {
                if (schoolValue) {
                    ensureSelectOption(userSchoolSelect, schoolValue);
                    userSchoolSelect.value = schoolValue;
                } else {
                    userSchoolSelect.value = '';
                }
                userSchoolSelect.dispatchEvent(new Event('change'));
            }

            if (userDepartmentSelect) {
                if (departmentValue) {
                    ensureSelectOption(userDepartmentSelect, departmentValue);
                    userDepartmentSelect.value = departmentValue;
                } else {
                    userDepartmentSelect.value = '';
                }
            }
        }

        function setupInputNavigation() {
            userFormNavElements = Array.from(document.querySelectorAll('[data-nav="user-form"]'));
            const focusField = (index) => {
                const target = userFormNavElements[index];
                if (target) {
                    target.focus();
                    if (typeof target.select === 'function') {
                        target.select();
                    }
                }
            };

            userFormNavElements.forEach((el, idx) => {
                el.addEventListener('keydown', (event) => {
                    if (!['ArrowRight', 'ArrowLeft', 'ArrowUp', 'ArrowDown'].includes(event.key)) {
                        return;
                    }
                    event.preventDefault();
                    if (event.key === 'ArrowRight' || event.key === 'ArrowDown') {
                        const nextIndex = (idx + 1) % userFormNavElements.length;
                        focusField(nextIndex);
                    } else {
                        const prevIndex = (idx - 1 + userFormNavElements.length) % userFormNavElements.length;
                        focusField(prevIndex);
                    }
                });
            });
        }

        function invalidateComplaintsCache() {
            dataCache.complaints = null;
            dataCache.complaintsTimestamp = 0;
        }

        function invalidateUsersCache() {
            dataCache.users = null;
            dataCache.usersTimestamp = 0;
        }

        async function getCachedComplaints(force = false) {
            const now = Date.now();
            if (!force && dataCache.complaints && (now - dataCache.complaintsTimestamp) < CACHE_TTL) {
                return dataCache.complaints;
            }
            const complaints = await complaintsAPI.getAll({});
            dataCache.complaints = complaints;
            dataCache.complaintsTimestamp = now;
            return complaints;
        }

        async function getCachedUsers(force = false) {
            const now = Date.now();
            if (!force && dataCache.users && (now - dataCache.usersTimestamp) < CACHE_TTL) {
                return dataCache.users;
            }
            const users = await usersAPI.getAll();
            dataCache.users = users;
            dataCache.usersTimestamp = now;
            return users;
        }
        function buildSchoolDepartmentMap(fromComplaints = [], fromUsers = []) {
            const map = new Map();
            const canonicalSchools = new Map();

            if (typeof schoolsData === 'object' && schoolsData !== null) {
                Object.keys(schoolsData).forEach(label => {
                    canonicalSchools.set(normalizeValue(label), label);
                });
            }

            const addEntry = (school, department) => {
                const normalizedSchoolRaw = normalizeValue(school);
                if (!normalizedSchoolRaw) return;

                const canonicalLabel = canonicalSchools.get(normalizedSchoolRaw);
                if (!canonicalLabel) return; // skip non-canonical schools like MCA, SOE, etc.

                const normalizedSchool = normalizeValue(canonicalLabel);
                if (!map.has(normalizedSchool)) {
                    map.set(normalizedSchool, {
                        label: canonicalLabel,
                        departments: new Map()
                    });
                }

                const normalizedDept = normalizeValue(department);
                if (normalizedDept) {
                    const deptLabel = (department || '').toString().trim();
                    const deptMap = map.get(normalizedSchool).departments;
                    if (!deptMap.has(normalizedDept)) {
                        deptMap.set(normalizedDept, deptLabel);
                    }
                }
            };

            if (typeof schoolsData === 'object' && schoolsData !== null) {
                Object.entries(schoolsData).forEach(([schoolLabel, departments]) => {
                    if (Array.isArray(departments) && departments.length > 0) {
                        departments.forEach(deptLabel => addEntry(schoolLabel, deptLabel));
                    } else {
                        addEntry(schoolLabel);
                    }
                });
            }

            fromComplaints.forEach(c => addEntry(c.school, c.department));
            fromUsers.forEach(u => addEntry(u.school, u.department));
            return map;
        }

        function populateSchoolSelect(selectEl, map, selectedValue = '') {
            if (!selectEl) return '';
            const entries = Array.from(map.entries()).map(([key, value]) => ({
                key,
                label: value.label || key
            })).sort((a, b) => a.label.localeCompare(b.label));

            selectEl.innerHTML = '<option value=\"\">All Schools</option>';
            entries.forEach(({ key, label }) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = label;
                selectEl.appendChild(option);
            });

            if (selectedValue && map.has(selectedValue)) {
                selectEl.value = selectedValue;
                return selectedValue;
            }

            selectEl.value = '';
            return '';
        }

        function populateDepartmentSelect(selectEl, map, schoolValue, selectedDept = '', options = {}) {
            if (!selectEl) return '';
            const disableWithoutSchool = options.disableWithoutSchool ?? false;
            selectEl.innerHTML = '<option value=\"\">All Departments</option>';

            if (!schoolValue || !map.has(schoolValue)) {
                if (disableWithoutSchool) {
                    selectEl.disabled = true;
                    selectEl.title = 'Select a school to enable department filtering';
                } else {
                    selectEl.disabled = false;
                    selectEl.title = '';
                }
                selectEl.value = '';
                return '';
            }

            selectEl.disabled = false;
            selectEl.title = '';

            const deptMap = map.get(schoolValue).departments;
            const entries = Array.from(deptMap.entries()).map(([key, label]) => ({
                key,
                label
            })).sort((a, b) => a.label.localeCompare(b.label));

            entries.forEach(({ key, label }) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = label;
                selectEl.appendChild(option);
            });

            if (selectedDept && deptMap.has(selectedDept)) {
                selectEl.value = selectedDept;
                return selectedDept;
            }

            selectEl.value = '';
            return '';
        }

        // Check authentication - verify token is still valid
        async function checkAuth() {
            const token = storage.getToken();
            const cachedUser = storage.getUser();
            const welcomeEl = document.getElementById('welcomeName');

            const setWelcomeName = (payload) => {
                if (!welcomeEl || !payload) return;
                const name = payload.name || [payload.firstName, payload.lastName].filter(Boolean).join(' ').trim() || 'Admin';
                welcomeEl.textContent = name;
            };

            if (!token) {
                window.location.href = '/index.html';
                return false;
            }

            try {
                const profile = await authAPI.getMe();
                if (normalizeRole(profile.role) !== 'admin') {
                    storage.clear();
                    window.location.href = '/index.html';
                    return false;
                }
                const mergedUser = {
                    ...cachedUser,
                    ...profile,
                    name: profile?.name || cachedUser?.name || [profile?.firstName, profile?.lastName].filter(Boolean).join(' ').trim()
                };
                storage.setUser(mergedUser);
                setWelcomeName(mergedUser);
                return true;
            } catch (error) {
                if (error?.status === 401 || error?.status === 403) {
                    storage.clear();
                    window.location.href = '/index.html';
                    return false;
                }
                if (cachedUser && normalizeRole(cachedUser.role) === 'admin') {
                    console.warn('Auth verification failed, continuing with cached session:', error);
                    setWelcomeName(cachedUser);
                    return true;
                }
                window.location.href = '/index.html';
                return false;
            }
        }

        // Chart instances
        let schoolChart = null;
        let departmentChart = null;
        let statusChart = null;

        // Load data function
        async function loadDashboardData(force = false) {
            await Promise.all([
                loadUsers(force),
                loadComplaints(force),
                loadAnalytics(force)
            ]);
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Setup role change listener for email field visibility
            const roleSelect = document.getElementById('umRole');
            if (roleSelect) {
                roleSelect.addEventListener('change', updateEmailFieldVisibility);
                updateEmailFieldVisibility(); // Initialize on load
            }
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                setupSchoolDepartmentDropdowns('umSchool', 'umDepartment', {
                    schoolIncludeEmpty: true,
                    schoolEmptyText: 'Select School',
                    departmentIncludeEmpty: true,
                    departmentEmptyText: 'Select Department'
                });
                attachPasswordToggle('umPassword', 'umPasswordToggle');
                setupInputNavigation();
                await loadDashboardData(true);
                initSectionNavigation({
                    menuSelector: '.sidebar .nav-item',
                    offset: 120,
                    scrollContainerSelector: '.dashboard-shell .main'
                });
            }
        });

        // Refresh data when page becomes visible (handles refresh)
        let visibilityTimeout = null;
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                if (visibilityTimeout) clearTimeout(visibilityTimeout);
                visibilityTimeout = setTimeout(async () => {
                    const user = storage.getUser();
                    const token = storage.getToken();
                    if (user && token) {
                        try {
                            await authAPI.getMe(); // Verify token is still valid
                            await loadDashboardData(true);
                        } catch (error) {
                            // Token expired, will be handled by checkAuth on next page load
                        }
                    }
                }, 400);
            }
        });

        // Priority filter function - scrolls to complaints section
        async function filterByPriority(priority) {
            // Set the priority filter dropdown value
            const priorityFilter = document.getElementById('priorityFilter');
            if (priorityFilter) {
                priorityFilter.value = priority;
            }
            
            // Update active state for priority cards
            document.querySelectorAll('.priority-filter-card').forEach(card => {
                if (card.dataset.priority === priority) {
                    card.style.transform = 'scale(1.05)';
                    card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.4)';
                    card.style.border = '2px solid rgba(255,255,255,0.8)';
                } else {
                    card.style.transform = 'scale(1)';
                    card.style.boxShadow = '';
                    card.style.border = '';
                }
            });
            
            // Scroll to complaints section immediately
            const complaintsSection = document.getElementById('complaints');
            if (complaintsSection) {
                complaintsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Load complaints with filter
            await loadComplaints();
            
            // Scroll to complaints section again after loading and highlight matching complaint
            setTimeout(async () => {
                const complaintsSection = document.getElementById('complaints');
                if (complaintsSection) {
                    complaintsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Find first complaint with matching priority and highlight it
                const complaintItems = document.querySelectorAll('.complaint-item');
                let targetComplaint = null;
                const allComplaints = await getCachedComplaints(false);
                for (const item of complaintItems) {
                    const itemId = item.id.replace('complaint-', '');
                    const matchingComplaint = allComplaints.find(c => (c._id || c.id) === itemId);
                    if (matchingComplaint && (matchingComplaint.priority || 'medium').toLowerCase() === priority.toLowerCase()) {
                        targetComplaint = item;
                        break;
                    }
                }
                
                if (targetComplaint) {
                    // Scroll to the specific complaint
                    targetComplaint.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight the complaint briefly
                    targetComplaint.style.transition = 'background-color 0.3s, box-shadow 0.3s';
                    targetComplaint.style.backgroundColor = '#fff5f5';
                    targetComplaint.style.boxShadow = '0 8px 24px rgba(255, 107, 107, 0.3)';
                    setTimeout(() => {
                        targetComplaint.style.backgroundColor = '';
                        targetComplaint.style.boxShadow = '';
                    }, 2000);
                }
            }, 300);
        }

        // Scroll to specific complaint
        function scrollToComplaint(complaintId) {
            const complaintElement = document.getElementById(`complaint-${complaintId}`);
            if (complaintElement) {
                const mainContainer = document.querySelector('.main');
                const headerHeight = document.querySelector('.dashboard-header')?.offsetHeight || 0;
                const offset = complaintElement.offsetTop - headerHeight - 20;
                if (mainContainer) {
                    mainContainer.scrollTo({ top: offset, behavior: 'smooth' });
                } else {
                    window.scrollTo({ top: offset, behavior: 'smooth' });
                }
                complaintElement.style.transition = 'background-color 0.3s';
                complaintElement.style.backgroundColor = '#fff9e6';
                setTimeout(() => {
                    complaintElement.style.backgroundColor = '';
                }, 2000);
            }
        }

        // Load complaints for admin
        async function loadComplaints(force = false) {
            const schoolSelect = document.getElementById('schoolFilter');
            const deptSelect = document.getElementById('deptFilter');
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const priorityFilter = document.getElementById('priorityFilter')?.value || '';
            
            let schoolFilter = normalizeValue(schoolSelect.value);
            let deptFilter = normalizeValue(deptSelect.value);
            
            try {
                // Get cached datasets
                const complaints = await getCachedComplaints(force);
                const usersForFilters = await getCachedUsers(force);
                
                // Populate school and department filter dropdowns using master data
                const schoolDeptMap = buildSchoolDepartmentMap(complaints, usersForFilters);
                
                schoolFilter = populateSchoolSelect(schoolSelect, schoolDeptMap, schoolFilter);
                deptFilter = populateDepartmentSelect(deptSelect, schoolDeptMap, schoolFilter, deptFilter, { disableWithoutSchool: true });
                
                // Filter locally for best performance
                let filteredComplaints = complaints;
                if (statusFilter && statusFilter.trim() !== '') {
                    const normalizedStatus = normalizeValue(statusFilter);
                    filteredComplaints = filteredComplaints.filter(c => 
                        normalizeValue(c.status) === normalizedStatus
                    );
                }
                if (categoryFilter && categoryFilter.trim() !== '') {
                    const normalizedCategory = normalizeValue(categoryFilter);
                    filteredComplaints = filteredComplaints.filter(c => 
                        normalizeValue(c.category) === normalizedCategory
                    );
                }
                if (priorityFilter && priorityFilter.trim() !== '') {
                    filteredComplaints = filteredComplaints.filter(c => 
                        (c.priority || 'medium').toLowerCase() === priorityFilter.toLowerCase()
                    );
                }
                if (schoolFilter) {
                    filteredComplaints = filteredComplaints.filter(c => 
                        normalizeValue(c.school) === schoolFilter
                    );
                }
                if (deptFilter) {
                    filteredComplaints = filteredComplaints.filter(c => 
                        normalizeValue(c.department) === deptFilter
                    );
                }
                
                displayComplaints(filteredComplaints);
            } catch (error) {
                console.error('Failed to load complaints:', error);
                document.getElementById('complaintList').innerHTML = '<p>Failed to load complaints</p>';
            }
        }

        function displayComplaints(complaints) {
            const list = document.getElementById('complaintList');
            if (!list) return;
            const statusFilter = document.getElementById('statusFilter').value;
            const orderedComplaints = sortComplaintsByPriority(complaints || []);
            
            if (orderedComplaints.length === 0) {
                const filterMessage = statusFilter 
                    ? `No complaints found with status "${statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1).replace('-', ' ')}"`
                    : 'No complaints found';
                list.classList.add('empty');
                list.classList.remove('scrollable');
                list.innerHTML = `<div style="text-align: center; padding: 40px; color: #999;"><p style="font-size: 18px;">${filterMessage}</p><p style="font-size: 14px; margin-top: 10px;">Try selecting a different filter or clear filters to see all complaints.</p></div>`;
                return;
            }
            
            list.classList.remove('empty');
            list.classList.add('scrollable');
            list.innerHTML = orderedComplaints.map(complaint => `
                <div class="complaint-item" id="complaint-${complaint._id}" style="border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                    <div class="complaint-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${complaint.title}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">${complaint.description}</div>
                        </div>
                        <span class="status-badge ${getStatusClass(complaint.status)}" onclick="scrollToComplaint('${complaint._id}')" style="cursor: pointer;" title="Click to scroll to this complaint">${complaint.status.charAt(0).toUpperCase() + complaint.status.slice(1).replace('-', ' ')}</span>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 13px; color: #666; margin-bottom: 10px;">
                        <span><strong>School:</strong> ${complaint.school || 'N/A'}</span>
                        <span><strong>Department:</strong> ${complaint.department || 'N/A'}</span>
                        <span><strong>Category:</strong> ${complaint.category}${complaint.subcategory ? ' - ' + complaint.subcategory : ''}</span>
                        <span><strong>Priority:</strong> <span onclick="scrollToComplaint('${complaint._id}')" style="cursor: pointer;">${getPriorityBadge(complaint.priority)}</span></span>
                        <span><strong>Date:</strong> ${formatDate(complaint.createdAt)}</span>
                    </div>
                    ${complaint.userId ? `<div style="font-size: 13px; color: #666; margin-bottom: 10px;"><strong>Submitted by:</strong> ${complaint.userId.firstName} ${complaint.userId.lastName} (<a href="mailto:${complaint.userId.email}" style="color: #1E88E5; text-decoration: none;">${complaint.userId.email}</a>)</div>` : ''}
                    ${complaint.photos && complaint.photos.length > 0 ? `
                        <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
                            ${complaint.photos.map(photo => `
                                <img src="${assetBase}${photo}" onclick="window.open('${assetBase}${photo}', '_blank')" style="width: 120px; height: 120px; object-fit: cover; cursor: pointer; border-radius: 8px; border: 2px solid #e0e0e0;">
                            `).join('')}
                        </div>
                    ` : ''}
                    ${complaint.video && complaint.video.length > 0 ? `
                        <div style="margin-top: 10px;">
                            <video controls style="width: 100%; max-width: 500px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <source src="${assetBase}${complaint.video[0]}" type="video/mp4">
                                <source src="${assetBase}${complaint.video[0]}" type="video/webm">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    ` : ''}
                    ${complaint.voice && complaint.voice.length > 0 ? `
                        <div style="margin-top: 10px;">
                            <audio controls style="width: 100%; max-width: 400px;">
                                <source src="${assetBase}${complaint.voice[0]}" type="audio/webm">
                            </audio>
                        </div>
                    ` : ''}
                    ${complaint.feedback && complaint.feedback.rating ? `
                        <div style="margin-top: 20px; padding: 24px; background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%); border-radius: 16px; border: 3px solid #ffc107; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.25);">
                            <h4 style="margin-top: 0; margin-bottom: 16px; color: #f57c00; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 24px;">⭐</span> Student Feedback
                            </h4>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-weight: 600; color: #333;">Rating:</span>
                                <div style="display: flex; gap: 4px; font-size: 20px;">
                                    ${'⭐'.repeat(complaint.feedback.rating)}${'☆'.repeat(5 - complaint.feedback.rating)}
                                </div>
                                <span style="font-weight: 700; color: #f57c00; font-size: 18px;">${complaint.feedback.rating}/5</span>
                            </div>
                            ${complaint.feedback.comment ? `
                                <div style="margin-top: 16px; padding: 16px; background: white; border-radius: 10px; border-left: 4px solid #ffc107;">
                                    <p style="margin: 0 0 8px 0; font-weight: 600; color: #333;">Student's Comment:</p>
                                    <p style="margin: 0; color: #555; line-height: 1.6; font-style: italic;">"${complaint.feedback.comment}"</p>
                                </div>
                            ` : ''}
                            <p style="margin-top: 16px; margin-bottom: 0; font-size: 13px; color: #666; font-style: italic;">Submitted on ${formatDate(complaint.feedback.submittedAt)}</p>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Load users for assignment
        async function loadUsers(force = false) {
            try {
                allUsers = await getCachedUsers(force);
                const facultyUsers = allUsers.filter(u => u.role === 'staff' || u.role === 'admin');
                const select = document.getElementById('modalAssignTo');
                if (select) {
                    select.innerHTML = '<option value=\"\">Unassigned</option>';
                    facultyUsers.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u._id || u.id;
                        const displayName = (u.firstName && u.lastName) ? `${u.firstName} ${u.lastName}` : (u.name || 'Unknown');
                        option.textContent = `${displayName} (${u.email})`;
                        select.appendChild(option);
                    });
                }

                // Render users table
                renderUsersTable(allUsers);
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            if (!tbody) return;
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding:10px;">No users</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(u => {
                const displayName = (u.firstName && u.lastName) ? `${u.firstName} ${u.lastName}` : (u.name || 'Unknown');
                return `
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${displayName}</td>
                        <td style="padding:8px; border-bottom:1px solid #f0f0f0;"><a href="mailto:${u.email}" style="color: #1E88E5; text-decoration: none;">${u.email}</a></td>
                        <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${buildPhoneChipHtml(u.phone)}</td>
                        <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${displayValue(u.role)}</td>
                        <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${displayValue(u.department)}</td>
                        <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${displayValue(u.school)}</td>
                        <td style="padding:8px; border-bottom:1px solid #f0f0f0;">
                            <button class="btn-sm" onclick="prefillUserForm('${u._id || u.id}')">Edit</button>
                            <button class="btn-sm btn-danger" onclick="deleteUser('${u._id || u.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function prefillUserForm(id) {
            const u = allUsers.find(x => (x._id || x.id) === id);
            if (!u) return;
            document.getElementById('umFirstName').value = u.firstName || '';
            document.getElementById('umLastName').value = u.lastName || '';
            document.getElementById('umEmail').value = u.email || '';
            document.getElementById('umPhone').value = u.phone || '';
            setAdminFormSchoolAndDepartment(u.school || '', u.department || '');
            document.getElementById('umRole').value = u.role || 'student';
            document.getElementById('umStudentId').value = u.studentId || '';
            document.getElementById('umPassword').value = '';
            document.getElementById('umEmail').dataset.userId = id;
            updateEmailFieldVisibility();
        }

        function clearUserForm() {
            ['umFirstName','umLastName','umEmail','umPassword','umStudentId','umPhone'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            setAdminFormSchoolAndDepartment('', '');
            document.getElementById('umRole').value = 'student';
            delete document.getElementById('umEmail').dataset.userId;
            updateEmailFieldVisibility();
        }

        function updateEmailFieldVisibility() {
            const role = document.getElementById('umRole').value;
            const isAdmin = role === 'admin';
            const emailGroup = document.getElementById('umEmailGroup');
            const emailInput = document.getElementById('umEmail');
            const emailHint = document.getElementById('umEmailHint');
            const emailLabel = document.getElementById('umEmailLabel');
            
            emailGroup.style.display = 'flex';
            emailInput.required = true;
            emailInput.readOnly = false;
            emailInput.style.backgroundColor = '';
            emailInput.placeholder = 'yourname@gmail.com';
            emailHint.style.display = 'none';
            if (emailLabel) emailLabel.textContent = '(Must be @gmail.com)';
        }

        async function createUser() {
            const id = document.getElementById('umEmail').dataset.userId;
            const firstName = document.getElementById('umFirstName').value.trim();
            const lastName = document.getElementById('umLastName').value.trim();
            const email = document.getElementById('umEmail').value.trim();
            const password = document.getElementById('umPassword').value;
            const phone = document.getElementById('umPhone').value.trim();
            const school = (userSchoolSelect?.value || '').trim();
            const department = (userDepartmentSelect?.value || '').trim();
            const role = document.getElementById('umRole').value;
            const studentId = document.getElementById('umStudentId').value.trim() || undefined;

            const isAdmin = role === 'admin';
            const requiresDepartment = role === 'student' || role === 'staff';

            // Validation
            if (!firstName || !lastName || !phone || !role) {
                showError('Name, phone, and role are required.');
                return;
            }

            // Email is required for all users
            if (!email) {
                showError('Email is required.');
                return;
            }

            // All users must use @gmail.com
            if (!email.toLowerCase().endsWith('@gmail.com')) {
                showError('Email must be a valid @gmail.com address.');
                return;
            }

            if (!isAdmin) {
                if (!school) {
                    showError('School is required for non-admin users.');
                    return;
                }
                if (!department) {
                    showError('Department is required for students and faculty.');
                    return;
                }
            }

            if (!/^[6-9][0-9]{9}$/.test(phone)) {
                showError('Enter a valid 10-digit Indian mobile number.');
                return;
            }

            try {
                const payload = { 
                    firstName, 
                    lastName, 
                    email, 
                    phone, 
                    department, 
                    school, 
                    role, 
                    studentId
                };

                if (id) {
                    await usersAPI.update(id, payload);
                    showSuccess('User updated successfully');
                } else {
                    if (!isValidPassword(password)) {
                        showError('Password does not meet the policy.');
                        return;
                    }
                    const result = await usersAPI.create({ ...payload, password });
                    if (result && result.email) {
                        showSuccess(`User created successfully. Email: ${result.email}`);
                    } else {
                        showSuccess('User created successfully');
                    }
                }
                clearUserForm();
                invalidateUsersCache();
                await loadUsers(true);
            } catch (error) {
                showError(error.message || 'Operation failed');
            }
        }

        // Complaints UI removed for admin

        function openUpdateModal(id, status, notes, assignedTo) {
            currentComplaintId = id;
            document.getElementById('modalStatus').value = status;
            document.getElementById('modalNotes').value = notes || '';
            document.getElementById('modalAssignTo').value = assignedTo || '';
            document.getElementById('updateModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('updateModal').style.display = 'none';
            currentComplaintId = null;
        }

        async function saveComplaintUpdate() {
            if (!currentComplaintId) return;

            const status = document.getElementById('modalStatus').value;
            const notes = document.getElementById('modalNotes').value;
            const assignedTo = document.getElementById('modalAssignTo').value;

            try {
                await complaintsAPI.updateStatus(currentComplaintId, status, notes);
                if (assignedTo) {
                    await complaintsAPI.assign(currentComplaintId, assignedTo);
                }
                showSuccess('Complaint updated successfully!');
                closeModal();
                invalidateComplaintsCache();
                await Promise.all([loadComplaints(true), loadAnalytics(true)]);
            } catch (error) {
                showError(error.message || 'Failed to update complaint');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Delete this user?')) return;
            try {
                await usersAPI.remove(id);
                showSuccess('User deleted');
                invalidateUsersCache();
                await loadUsers(true);
            } catch (error) {
                showError(error.message || 'Failed to delete user');
            }
        }


        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                storage.clear();
                window.location.href = '/index.html';
            }
        }

        // Close modal when clicking outside
        document.getElementById('updateModal').addEventListener('click', (e) => {
            if (e.target.id === 'updateModal') {
                closeModal();
            }
        });

        // Load analytics and charts
        async function loadAnalytics(force = false) {
            try {
                const timeFilter = document.getElementById('timeFilter').value;
                const schoolSelect = document.getElementById('analyticsSchoolFilter');
                const deptSelect = document.getElementById('analyticsDeptFilter');
                let schoolFilter = normalizeValue(schoolSelect.value);
                let deptFilter = normalizeValue(deptSelect.value);
                
                const complaints = await getCachedComplaints(force);
                
                // Apply time filter
                const now = new Date();
                let startDate = null;
                
                if (timeFilter === 'all') {
                    // All time - no filter
                    startDate = null;
                } else if (timeFilter === 'daily') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                } else if (timeFilter === 'weekly') {
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek;
                    startDate = new Date(now.getFullYear(), now.getMonth(), diff, 0, 0, 0, 0);
                } else if (timeFilter === 'monthly') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
                } else if (timeFilter === 'yearly') {
                    startDate = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);
                }
                
                let filteredComplaints = complaints;
                if (startDate) {
                    filteredComplaints = complaints.filter(c => {
                        const complaintDate = new Date(c.createdAt);
                        return complaintDate >= startDate;
                    });
                }
                
                // Populate school/department filters and then apply them
                const analyticsUsers = await getCachedUsers(force);
                const schoolDeptMap = buildSchoolDepartmentMap(complaints, analyticsUsers);
                schoolFilter = populateSchoolSelect(schoolSelect, schoolDeptMap, schoolFilter);
                deptFilter = populateDepartmentSelect(deptSelect, schoolDeptMap, schoolFilter, deptFilter, { disableWithoutSchool: true });
                
                if (schoolFilter) {
                    filteredComplaints = filteredComplaints.filter(c => normalizeValue(c.school) === schoolFilter);
                }
                if (deptFilter) {
                    filteredComplaints = filteredComplaints.filter(c => normalizeValue(c.department) === deptFilter);
                }
                
                // Update statistics
                const rejected = filteredComplaints.filter(c => c.status === 'rejected').length;
                const inProgress = filteredComplaints.filter(c => c.status === 'in-progress').length;
                const completed = filteredComplaints.filter(c => c.status === 'completed').length;
                const pending = filteredComplaints.filter(c => c.status === 'pending').length;
                
                // Update priority counts
                const urgent = filteredComplaints.filter(c => c.priority === 'urgent').length;
                const high = filteredComplaints.filter(c => c.priority === 'high').length;
                const medium = filteredComplaints.filter(c => c.priority === 'medium').length;
                const low = filteredComplaints.filter(c => c.priority === 'low').length;
                
                document.getElementById('rejectedComplaints').textContent = rejected;
                document.getElementById('inProgressComplaints').textContent = inProgress;
                document.getElementById('completedComplaints').textContent = completed;
                document.getElementById('pendingComplaints').textContent = pending;
                
                document.getElementById('urgentCount').textContent = urgent;
                document.getElementById('highCount').textContent = high;
                document.getElementById('mediumCount').textContent = medium;
                document.getElementById('lowCount').textContent = low;
                
                // Prepare chart data
                const schoolData = {};
                const departmentData = {};
                const statusData = {};
                
                filteredComplaints.forEach(c => {
                    // School data
                    const school = c.school || 'Unknown';
                    schoolData[school] = (schoolData[school] || 0) + 1;
                    
                    // Department data
                    const dept = c.department || 'Unknown';
                    departmentData[dept] = (departmentData[dept] || 0) + 1;
                    
                    // Status data
                    const status = c.status || 'pending';
                    statusData[status] = (statusData[status] || 0) + 1;
                });
                
                // Update charts
                updateSchoolChart(schoolData);
                updateDepartmentChart(departmentData);
                updateStatusChart(statusData);
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }
        
        function updateSchoolChart(data) {
            const ctx = document.getElementById('schoolChart');
            if (schoolChart) schoolChart.destroy();
            
            schoolChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Complaints',
                        data: Object.values(data),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateDepartmentChart(data) {
            const ctx = document.getElementById('departmentChart');
            if (departmentChart) departmentChart.destroy();
            
            departmentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Complaints',
                        data: Object.values(data),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(255, 87, 34, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        function updateStatusChart(data) {
            const ctx = document.getElementById('statusChart');
            if (statusChart) statusChart.destroy();
            
            const statusLabels = ['pending', 'in-progress', 'completed', 'rejected'];
            const statusColors = {
                'pending': 'rgba(245, 158, 11, 0.8)',
                'in-progress': 'rgba(59, 130, 246, 0.8)',
                'completed': 'rgba(16, 185, 129, 0.8)',
                'rejected': 'rgba(107, 114, 128, 0.8)'
            };
            
            statusChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        label: 'Complaints by Status',
                        data: statusLabels.map(s => data[s] || 0),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
