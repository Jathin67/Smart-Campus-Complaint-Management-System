<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Campus Complaint System</title>
    <link rel="stylesheet" href="css/style.css">
    </head>
<body class="auth">
    <div class="container">
        <div class="login-header">
            <img src="/College-Logo.jpg" alt="College Logo" class="college-logo" id="collegeLogo">
            <h1>Forgot Password</h1>
            <p class="subtitle">Enter your email or phone number to receive a reset link</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <form id="forgotForm">
            <div class="form-group">
                <label for="identifier">Email or Phone Number</label>
                <input type="text" id="identifier" name="identifier" required placeholder="email@example.com or 10-digit phone">
                <small>You can enter either your email address or 10-digit phone number</small>
            </div>
            <button type="submit" class="btn" id="submitBtn">Send Reset Link</button>
        </form>

        <div class="switch-link">
            <p><a href="index.html">Back to Login</a></p>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        document.getElementById('forgotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('identifier').value.trim();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            try {
                const res = await authAPI.forgot(identifier);
                console.log('Forgot password response:', res);
                
                const successDiv = document.getElementById('successMessage');
                const errorDiv = document.getElementById('errorMessage');
                
                // Hide error message
                errorDiv.style.display = 'none';
                
                if (res && res.resetUrl) {
                    console.log('Reset URL received:', res.resetUrl);
                    // Always show the reset link prominently
                    let message = res.message || 'Reset link generated successfully!';
                    message += '<br><br>';
                    message += '<strong style="color: #1565C0;">Reset Link:</strong><br>';
                    message += `<a href="${res.resetUrl}" style="color: #1565C0; font-weight: bold; text-decoration: underline; word-break: break-all; display: inline-block; margin-top: 10px;">${res.resetUrl}</a>`;
                    message += '<br><br>';
                    message += '<button onclick="window.location.href=\'' + res.resetUrl + '\'" style="background-color: #1565C0; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px;">Click Here to Reset Password</button>';
                    
                    if (res.email) {
                        message += `<br><br><small>Email: ${res.email}</small>`;
                    }
                    if (res.phone) {
                        message += `<br><small>Phone: ${res.phone}</small>`;
                    }
                    if (res.emailSent === false) {
                        if (res.smtpConfigured === false) {
                            message += '<br><br><small style="color: #ff9800; font-weight: bold;">⚠ Email service is not configured. Please use the link above to reset your password.</small>';
                        } else if (res.emailError) {
                            message += '<br><br><small style="color: #f44336; font-weight: bold;">⚠ Email sending failed: ' + res.emailError + '. Please use the link above to reset your password.</small>';
                        } else {
                            message += '<br><br><small style="color: #ff9800;">Note: Email could not be sent. Please use the link above to reset your password.</small>';
                        }
                    }
                    
                    successDiv.innerHTML = message;
                    successDiv.style.display = 'block';
                    showSuccess(res.message || 'Reset link generated successfully!');
                } else {
                    // No reset link in response - might be that user doesn't exist or error occurred
                    showSuccess(res.message || 'If the email/phone exists, a reset link has been sent.');
                    if (res && res.message) {
                        successDiv.innerHTML = res.message;
                        successDiv.style.display = 'block';
                    }
                }
            } catch (err) {
                console.error('Forgot password error:', err);
                showError(err.message || 'Failed to send reset link. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            }
        });

        const collegeLogo = localStorage.getItem('collegeLogo');
        if (collegeLogo) {
            document.getElementById('collegeLogo').src = collegeLogo;
        }
    </script>
</body>
</html>


