<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Campus Complaint System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="login-header">
            <img src="/College-Logo.jpg" alt="College Logo" class="college-logo" id="collegeLogo">
            <h1>Reset Password</h1>
            <p class="subtitle">Set a new password</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <form id="resetForm">
            <div class="form-group">
                <label for="password">New Password</label>
                <div class="input-group">
                    <input type="password" id="password" name="password" required pattern="[A-Za-z0-9!@#$%&*]{8,13}" minlength="8" maxlength="13">
                    <button type="button" id="togglePassword" class="password-toggle" aria-label="Show password">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M12 5c-5.05 0-9.27 3.17-11 7 1.73 3.83 5.95 7 11 7s9.27-3.17 11-7c-1.73-3.83-5.95-7-11-7zm0 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" fill="currentColor"></path>
                            <path class="slash" d="M4 4l16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                        </svg>
                    </button>
                </div>
                <small>Password must be 8-13 chars with at least 1 uppercase, 1 lowercase, 1 number, and 1 special (!@#$%&*).</small>
            </div>
            <button type="submit" class="btn" id="submitBtn">Reset Password</button>
        </form>

        <div class="switch-link">
            <p><a href="index.html">Back to Login</a></p>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const email = params.get('email');
        const phone = params.get('phone');

        if (!token || (!email && !phone)) {
            document.getElementById('errorMessage').textContent = 'Invalid password reset link';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('resetForm').style.display = 'none';
        }

        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pw = document.getElementById('password').value;
            const btn = document.getElementById('submitBtn');
            if (!isValidPassword(pw)) { showError('Password does not meet the policy.'); return; }
            btn.disabled = true;
            btn.textContent = 'Resetting...';
            try {
                // Use email if available, otherwise use phone
                const identifier = email || phone;
                await authAPI.reset(identifier, token, pw);
                showSuccess('Password has been reset. You can login now.');
                setTimeout(() => { window.location.href = 'index.html'; }, 1500);
            } catch (err) {
                showError(err.message || 'Failed to reset password');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Reset Password';
            }
        });

        const collegeLogo = localStorage.getItem('collegeLogo');
        if (collegeLogo) {
            document.getElementById('collegeLogo').src = collegeLogo;
        }
        attachPasswordToggle('password', 'togglePassword');
    </script>
</body>
</html>


